{"version":3,"file":"CbtG6qj9rjIIDoHC8wMW.js","sources":["../../src/stores/UpdaterStore.ts"],"sourcesContent":["import { invoke } from \"@tauri-apps/api/core\";\nimport { listen } from \"@tauri-apps/api/event\";\nimport { action, makeAutoObservable, observable } from \"mobx\";\nimport useLogger from \"../hooks/useLogger\";\nimport Logger from \"../utils/Logger\";\nimport AppStore from \"./AppStore\";\n\nexport default class UpdaterStore {\n\tprivate readonly logger: Logger = useLogger(\"UpdaterStore\");\n\t@observable initialized: boolean = false;\n\t@observable enabled: boolean = true;\n\t@observable checkingForUpdates: boolean = false;\n\t@observable updateDownloading: boolean = false;\n\t@observable updateDownloaded: boolean = false;\n\t@observable updateAvailable: boolean = false;\n\t@observable timer: NodeJS.Timeout | null = null;\n\n\tconstructor(private readonly app: AppStore) {\n\t\tthis.logger.info(\"Initializing UpdaterStore\");\n\t\tmakeAutoObservable(this);\n\n\t\tconst setupListeners = async () => {\n\t\t\tawait listen(\"CHECKING_FOR_UPDATE\", () => {\n\t\t\t\tthis.logger.debug(\"Checking for updates\");\n\t\t\t\tthis.setCheckingForUpdates(true);\n\t\t\t\tthis.setUpdateAvailable(false);\n\t\t\t\tthis.setUpdateDownloading(false);\n\t\t\t\tthis.setUpdateDownloaded(false);\n\t\t\t});\n\n\t\t\tawait listen(\"UPDATE_AVAILABLE\", () => {\n\t\t\t\tthis.logger.debug(\"Update available\");\n\t\t\t\tthis.setCheckingForUpdates(false);\n\t\t\t\tthis.setUpdateAvailable(true);\n\t\t\t\tthis.setUpdateDownloading(false);\n\t\t\t\tthis.setUpdateDownloaded(false);\n\t\t\t});\n\n\t\t\tawait listen(\"UPDATE_NOT_AVAILABLE\", () => {\n\t\t\t\tthis.logger.debug(\"Update not available\");\n\t\t\t\tthis.setCheckingForUpdates(false);\n\t\t\t\tthis.setUpdateAvailable(false);\n\t\t\t\tthis.setUpdateDownloading(false);\n\t\t\t\tthis.setUpdateDownloaded(false);\n\t\t\t});\n\n\t\t\tawait listen(\"UPDATE_DOWNLOADING\", () => {\n\t\t\t\tthis.logger.debug(\"Update downloading\");\n\t\t\t\tthis.setCheckingForUpdates(false);\n\t\t\t\tthis.setUpdateAvailable(false);\n\t\t\t\tthis.setUpdateDownloading(true);\n\t\t\t\tthis.setUpdateDownloaded(false);\n\t\t\t});\n\n\t\t\tawait listen(\"UPDATE_DOWNLOADED\", () => {\n\t\t\t\tthis.logger.debug(\"Update downloaded\");\n\t\t\t\tthis.setCheckingForUpdates(false);\n\t\t\t\tthis.setUpdateAvailable(false);\n\t\t\t\tthis.setUpdateDownloading(false);\n\t\t\t\tthis.setUpdateDownloaded(true);\n\t\t\t});\n\n\t\t\tawait listen(\"UPDATE_ERROR\", (e) => {\n\t\t\t\tthis.logger.debug(\"Update error\", e);\n\t\t\t\tthis.setCheckingForUpdates(false);\n\t\t\t\tthis.setUpdateAvailable(false);\n\t\t\t\tthis.setUpdateDownloading(false);\n\t\t\t\tthis.setUpdateDownloaded(false);\n\t\t\t});\n\t\t};\n\n\t\tsetupListeners();\n\n\t\twindow.updater = {\n\t\t\tsetUpdateAvailable: this.setUpdateAvailable.bind(this),\n\t\t\tsetUpdateDownloading: this.setUpdateDownloading.bind(this),\n\t\t\tsetUpdateDownloaded: this.setUpdateDownloaded.bind(this),\n\t\t\tsetCheckingForUpdates: this.setCheckingForUpdates.bind(this),\n\t\t\tcheckForUpdates: this.checkForUpdates.bind(this),\n\t\t\tdownloadUpdate: this.downloadUpdate.bind(this),\n\t\t\tquitAndInstall: this.quitAndInstall.bind(this),\n\t\t\tclearUpdateCache: this.clearCache.bind(this),\n\t\t};\n\t}\n\n\t@action\n\tsetCheckingForUpdates(value: boolean) {\n\t\tthis.checkingForUpdates = value;\n\t}\n\n\t@action\n\tsetUpdateAvailable(value: boolean) {\n\t\tthis.updateAvailable = value;\n\t}\n\n\t@action\n\tsetUpdateDownloading(value: boolean) {\n\t\tthis.updateDownloading = value;\n\t}\n\n\t@action\n\tsetUpdateDownloaded(value: boolean) {\n\t\tthis.updateDownloaded = value;\n\t}\n\n\tasync checkForUpdates() {\n\t\tif (this.checkingForUpdates) {\n\t\t\tthis.logger.warn(\"Already checking for updates, skipping check\");\n\t\t\treturn;\n\t\t}\n\n\t\t// if (this.app.settings.ignoreUpdates) {\n\t\t// \tthis.logger.warn(\"Ignoring updates, skipping check\");\n\t\t// \treturn;\n\t\t// }\n\t\tthis.logger.debug(\"Invoking update check\");\n\t\tawait invoke(\"check_for_updates\", { ignorePrereleases: false });\n\t}\n\n\tasync downloadUpdate() {\n\t\tif (this.updateDownloading) {\n\t\t\tthis.logger.warn(\"Already downloading an update\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.updateDownloaded) {\n\t\t\tthis.logger.warn(\"An update is already pending installation\");\n\t\t\treturn;\n\t\t}\n\n\t\tthis.logger.debug(\"Invoking update download\");\n\t\tawait invoke(\"download_update\");\n\t}\n\n\tasync quitAndInstall() {\n\t\tif (!this.updateDownloaded) {\n\t\t\tthis.logger.warn(\"No update is pending installation\");\n\t\t\treturn;\n\t\t}\n\n\t\tthis.logger.debug(\"Invoking update install\");\n\t\tawait invoke(\"install_update\");\n\t}\n\n\t@action\n\tsetEnabled(value: boolean) {\n\t\tthis.enabled = value;\n\n\t\tif (value) {\n\t\t\tthis.enable();\n\t\t} else {\n\t\t\tthis.disable();\n\t\t}\n\t}\n\n\t@action\n\tasync enable() {\n\t\tthis.logger.debug(\"Enabling updater\");\n\n\t\tif (this.initialized) {\n\t\t\tthis.logger.debug(\"Updater already initialized, skipping init\");\n\t\t\treturn;\n\t\t}\n\n\t\t// initial update check\n\t\tawait this.checkForUpdates();\n\n\t\t// start an update timer\n\t\tthis.timer = setInterval(async () => {\n\t\t\tthis.logger.debug(\"[UpdateTimer] Checking for updates\");\n\t\t\tawait this.checkForUpdates();\n\t\t}, 36e5); // 1 hour\n\n\t\tthis.initialized = true;\n\t}\n\n\t@action\n\tdisable() {\n\t\tthis.logger.debug(\"Disabling updater\");\n\t\tif (this.timer) {\n\t\t\tclearInterval(this.timer);\n\t\t}\n\t}\n\n\tasync clearCache() {\n\t\tthis.logger.debug(\"Clearing update cache\");\n\t\tawait invoke(\"clear_update_cache\");\n\t}\n}\n"],"names":["UpdaterStore","app","__publicField","useLogger","makeAutoObservable","listen","e","value","invoke","__decorateClass","observable","action"],"mappings":"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"}